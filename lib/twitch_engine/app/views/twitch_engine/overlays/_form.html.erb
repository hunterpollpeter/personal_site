<%= text_field_tag :name, @overlay.name, class: 'form-control mb-2 px-3 py-4' %>
<hr>
<div id="accordion">
  <% @elements.each do |name, options| %>
    <div class="element card mb-2" data-name="<%= name %>">
      <div class="card-header border-bottom-0 bg-light d-flex align-items-center">
        <a class="card-link text-dark handle" data-toggle="collapse" href="#collapse_<%= name %>" role="button" aria-expanded="false">
          <%= name.to_s.humanize %>
        </a>
        <div class="ml-auto d-flex align-items-center">
          <div class="toggle">
            <%= check_box_tag name, 'enabled', true?(options[:enabled]) %>
            <%= label_tag name, '', class: 'mb-0' %>
          </div>
        </div>
      </div>
      <div id="collapse_<%= name %>" class="collapse" data-parent="#accordion">
        <div class="card-body border-top">
          <%= options %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% content_for :script do %>
  <script type="text/javascript" charset="utf-8">
    $("#accordion").sortable({
        animation: 150,
        forceFallback: true,
        handle: ".handle",
        onUpdate: function () {
          update_options({options: {element_priority: $.map($('.element'), function(element) { return $(element).data('name') })}})
        }
    });

		$("input[type='checkbox']").change(function() {
			update_options({options: {elements: {[this.name]: {[this.value]: this.checked }}}});
		});

		$('#name').on('change keyup paste', function() {
		    update_name($(this).val());
    });

		function update_options(data) {
        $('#options').addClass('loading-cover');
        $.post('update', data)
            .done(function() {
                // reload iframe
                var $iframe = $('iframe');
                $iframe.removeClass('loaded');
                $iframe.attr( 'src', function ( _, val ) { return val; });
            })
            .fail(function () {
                this.checked = !this.checked
            })
            .always(function() {
                $('#options').removeClass('loading-cover');
            });
    }

    var name_timeout;
    function update_name(name) {
        clearTimeout(name_timeout);
        name_timeout = setTimeout(function() {
            $.post('update', {name: name});
        }, 1000);
    }
  </script>
<% end %>